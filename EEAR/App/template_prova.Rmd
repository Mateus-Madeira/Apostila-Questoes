---
title: "Prova Personalizada"
output:
  word_document:
    toc: true
    toc_depth: 2
params:
  questoes: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(dplyr)
library(knitr)
```

```{r gerar_questoes, results='asis'}
if (!is.null(params$questoes) && nrow(params$questoes) > 0) {

  ordem_prioritaria <- c("Português", "Inglês", "Matemática", "Física")
  materias_recebidas <- unique(params$questoes$materia)
  outras <- setdiff(materias_recebidas, ordem_prioritaria)
  ordem_final <- c(intersect(ordem_prioritaria, materias_recebidas), sort(outras))

  gabarito_final <- c()
  contador <- 1

  for (materia_atual in ordem_final) {
    cat("\n# ", materia_atual, "\n\n")

    questoes_mat <- params$questoes %>%
      filter(materia == materia_atual) %>%
      arrange(topico)

    topico_atual <- ""

    for (i in 1:nrow(questoes_mat)) {
      q <- questoes_mat[i, ]

      if (q$topico != topico_atual) {
        topico_atual <- q$topico
        cat("\n## ", topico_atual, "\n\n")
      }

      # --- MUDANÇA AQUI: Adiciona o texto (ANULADA) se necessário ---
      cabecalho <- paste0("**", contador, ") (", q$ano, "/", q$versao, ")** ")
      if (q$gabarito == "anulada") {
        cabecalho <- paste0(cabecalho, "**(ANULADA)** ")
      }
      
      cat(cabecalho, q$questao, "\n\n")

      alternativas <- c(
        paste0("a) ", q$alt_a),
        paste0("b) ", q$alt_b),
        paste0("c) ", q$alt_c),
        paste0("d) ", q$alt_d)
      )

      cat(paste(alternativas, collapse = "\n\n"))
      cat("\n\n---\n\n")

      # --- MUDANÇA AQUI: Adiciona "ANULADA" ao gabarito se necessário ---
      resposta_gabarito <- ifelse(q$gabarito == "anulada", "ANULADA", toupper(q$gabarito))
      gabarito_final <- c(gabarito_final, paste0(contador, ". ", resposta_gabarito))
      
      contador <- contador + 1
    }
  }

  cat("\n\n# Gabarito\n\n")
  cat(paste(gabarito_final, collapse = "\n\n"))
  
} else {
  cat("Nenhuma questão disponível para os filtros selecionados.")
}